<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Tex(t Se)cret</title>
<style>
  body {
    font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    max-width: 700px;
    margin: 3rem auto;
  }

  button {
    padding: .6rem 1rem;
    margin-right: .5rem;
  }

  #log {
    white-space: pre-wrap;
    background: #f6f6f8;
    padding: 1rem;
    border-radius: 8px;
  }

  .pass {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }

  .inputs {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }

  .user-data {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }

  .examples {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }
</style>
<h2>Tex(t Se)cret</h2>

<div class="user-data">
  <p>
    <label for="password">User name:</label>
    <input name="user-name" id="user-name" value="Jay" />
  </p>
  <p>
    <label for="user-email">User email:</label>
    <input name="user-email" id="user-email" value="jay@example.com" />
  </p>
</div>

<p><button id="register">Register key + store secret</button> Register writes a secret into the key‚Äôs largeBlob</p>
<p><button id="authenticate">Authenticate + read secret</button> Authenticate reads it and decrypts it</p>

<hr />

<p><button id="pass-to-secret">Load secret from password</button> Loads secret from the password</p>

<div class="pass">
  <p>
    <label for="password">Password:</label>
    <input name="password" id="password" type="password" value="" />
  </p>
  <p>
    <label for="confirm">Confirm:</label>
    <input name="confirm" id="confirm" type="password" value="" />
  </p>
</div>

<p></p>

<hr />

<p><span id="authState" class="muted">(secret not loaded)</span></p>

<hr />

<p><button id="encrypt">Encrypt plaintext</button> (with loaded secrets)</p>
<p><button id="decrypt">Decrypt ciphertext</button> (trying all loaded secrets until success)</p>

<p>
<div class="inputs">
  <p>
    <label for="pt">Plaintext:</label>
  </p>
  <p>
    <textarea name="pt" id="pt" value="" rows="3" cols="60">hello from the sea üê¨</textarea>
  </p>
  <p>
    <label for="ct">Ciphertext (base64):</label>
  </p>
  <p>
    <textarea name="ct" id="ct" value="" rows="6" cols="60"></textarea>
  </p>
</div>
</p>

<hr />

<p><button id="decretex">Decretex</button> Decrypt all texcrets on the page (you can also try magic!)</p>

<div class="examples">
  <h3>Examples for https://aleksandr.vin/texcret/</h3>
  Look, Ma:
  <p>
    This is encrypted with passkey on
    mac:<i>WUtMQjIA4RIx7tSh9VMwVLyQAA5zb21lIGZpbGUgbmFtZQABEzjo0nt4z25QwngSwZC/y8gvj19hJR0QiY8byAAw6tCWLCughCS6n1M6NE405qL2nXaQnw6YzDxcZHSdPWeK2rOdK4rJPrXEUJNxW7gccQ3EulzTARDcaRFMA/gR8bWB/H6f1mRW3F1ZfgZk7RUco89jVIoGpgRD41vZ37gTnnLjXiS4DjTUw9z+8vzhJw==</i>
  </p>
  <p>
    This on
    iPhone:WUtMQjIAvttQnv9JbxJLXopdAA5zb21lIGZpbGUgbmFtZQABerY5PWO3mwq0gOs9G7anyMI/FZqtAHCDP9OJVgAwlRPoCaQlJ0UY5/bSbb1Y+aRZleWH9dbvZ3wsnTV+Qi1HpTRH8e0hPS6nD/QZxPXJwBRrzhFKV+gEFnht2/m9QG6xx/FXKhbEw1GP6LHeVp1hxiWUfp2N:))
  </p>
  <p>
    And this with password
    (<code>dark secrets</code>) and passkey on
    mac:<code>WUtMQjIA3Z7HvLgDHrSw5RXxAA5zb21lIGZpbGUgbmFtZQACnnN1/iqic5ZrHGCBjbViDr6bjIeaAIbx26S5SgAwnlWKM5pLY3rzk+XO5pMsST0lNJwr6sNadDgESIB/igQx1k+vludisQ+QcRk+ozmsI1H6DGIu5wqZVbMXg17cnFy/Zr9RUesHmSJ9gQAwFQCK6ACKLv8EZo50bwICJgOHSFjxxcjnQD4W27DryGqCZrFFTrSZGEDRpAz1nQC2LsleZpEev/kp9GrjjA3HpkhPATXfrd/YDNZNJoLQf22/+Rjv8cp+BW2yNymGv0L91kxZZW1wNNRetEQ=</code>
  </p>
</div>

<hr />

<p>
<div id="log"></div>
</p>

<script>

  const $ = (sel) => { return document.querySelector(sel); };
  const log = (...a) => { $('#log').textContent += a.join(' ') + "\n"; };

  // ---- get user name and email from query string or fragments, trying different option aliases ----
  function parseNameEmail(url = location.href) {
    const u = new URL(url, location.origin);

    const qs = new URLSearchParams(u.search);
    const hs = new URLSearchParams(u.hash.startsWith('#') ? u.hash.slice(1) : u.hash);

    const first = (...keys) => {
      for (const k of keys) {
        const v = qs.get(k) ?? hs.get(k);
        if (v != null && v !== "") return v;
      }
      return null;
    };

    let name = first('name', 'full_name', 'user', 'username', 'u');
    let email = first('email', 'mail', 'e', 'user_email');

    const normalize = (s) => s ? s.replace(/\+/g, ' ').trim() : null;
    name = normalize(name);
    email = email ? email.trim() : null;

    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) email = null;

    return { name, email };
  }

  const { name, email } = parseNameEmail();
  const userName = name || "Jay";
  const userEmail = email || "jay@example.com";
  $("#user-name").value = userName;
  $("#user-email").value = userEmail;

  async function init() {
    Texcret.log = log;

    Texcret.setRPName("Tex(t Se)cret");
    Texcret.setUser(userEmail, userName);

    let secretsLoaded = 0;

    async function doRegister() {
      await Texcret.registerNewCredentialAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from registration)";
        $("#authState").className = "ok";
      });
    }

    async function doAuthenticate() {
      await Texcret.authenticateAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from authentication)";
        $("#authState").className = "ok";
      });
    }

    async function doLoadPassword() {
      const pass = $("#password").value;
      const confirm = $("#confirm").value;
      if (pass != confirm) {
        log("‚ùå Password does not match confirmation!");
        return;
      }
      await Texcret.loadPassword(pass, onOk = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last is password)";
        $("#authState").className = "ok";
      }, onError = (msg) => {
        log(msg);
      });
    }

    async function doEncrypt() {
      const data = Texcret.enc.encode($("#pt").value);
      const out = await Texcret.encrypt(data, "some file name");
      if (out) {
        $("#ct").value = Texcret.b64(out.buffer);
      }
    }

    async function doDecrypt() {
      const data = new Uint8Array(Texcret.ubuf($("#ct").value));
      const res = await Texcret.decrypt(data);
      if (res) {
        const pt = Texcret.dec.decode(res.buffer);
        log("üîì Decrypted plaintext:", pt);
        $("#pt").value = pt;
      }
    }

    // ---- Fake: generate random secret (not stored anywhere)
    async function doFake() {
      const secret = Texcret.randBytes(32); // store this in largeBlob
      const secretB64 = Texcret.b64(secret); // ArrayBuffer -> b64
      Texcret._secretsB64.push(secretB64);
      secretsLoaded += 1;
      $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last fake)";
      $("#authState").className = "ok";
      log("‚úÖ Faked secret (" + (secret.byteLength) + " bytes) " + secretB64);
    }

    async function doDecretex() {
      const matches = await Texcret.findAllTexcrets();
      const nodes = matches.map((v) => v.node);
      await Texcret.decretex(nodes);
    }

    /* ======= shuffle array https://en.wikipedia.org/wiki/Fisher‚ÄìYates_shuffle ====== */
    function shuffle(array) {

      let currentIndex = array.length;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {

        // Pick a remaining element...
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
    }

    $('#decrypt').onclick = doDecrypt;
    $('#encrypt').onclick = doEncrypt;
    $('#register').onclick = doRegister;
    $('#authenticate').onclick = doAuthenticate;
    $('#pass-to-secret').onclick = doLoadPassword;
    $('#decretex').onclick = doDecretex;

    await Texcret.magic();
  }
</script>

<script defer src="texcret.js" onload="init();"></script>
<!-- <script defer src="texcret.js" onload="Texcret.magic();"></script> -->

</html>