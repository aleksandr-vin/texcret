<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Tex(t Se)cret demo</title>
<style>
  body {
    font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    max-width: 700px;
    margin: 3rem auto;
  }

  button {
    padding: .6rem 1rem;
    margin-right: .5rem;
  }

  #log {
    white-space: pre-wrap;
    background: #f6f6f8;
    padding: 1rem;
    border-radius: 8px;
  }
</style>
<h2>Tex(t Se)cret demo</h2>
<p>Register writes a secret into the key‚Äôs largeBlob; Authenticate reads it and decrypts.</p>

<p><button id="register">Register key + store secret</button></p>
<p><button id="authenticate">Authenticate + read secret</button></p>
<p><button id="fake">Fake secret</button>&nbsp;<button id="shuffle">Shuffle secrets</button></p>
<p><button id="encrypt">Encrypt sample text (with stored secret)</button></p>
<p><button id="decrypt">Decrypt sample text</button></p>

<p><span id="authState" class="muted">(secret not loaded)</span></p>

<div class="inputs">
  <p>
    <label for="pt">Plaintext:</label>
  </p>
  <p>
    <textarea name="pt" id="pt" value="" rows="3" cols="60">hello from the sea üê¨</textarea>
  </p>
  <p>
    <label for="ct">Ciphertext (base64):</label>
  </p>
  <p>
    <textarea name="ct" id="ct" value="" rows="6" cols="60"></textarea>
  </p>
</div>

<div id="log"></div>

<script>

  const $ = (sel) => { return document.querySelector(sel); };
  const log = (...a) => { $('#log').textContent += a.join(' ') + "\n"; };

  async function init() {


    Texcret.log = log;

    Texcret.setRPName("Tex(t Se)cret Demo");
    Texcret.setUser("jay@example.com", "Jay");

    let secretsLoaded = 0;

    async function doRegister() {
      await Texcret.registerNewCredentialAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from registration)";
        $("#authState").className = "ok";
      });
    }

    async function doAuthenticate() {
      await Texcret.authenticateAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from authentication)";
        $("#authState").className = "ok";
      });
    }

    async function doEncrypt() {
      const data = Texcret.enc.encode($("#pt").value);
      const out = await Texcret.encrypt(data, "some file name");
      $("#ct").value = Texcret.b64(out.buffer);
    }

    async function doDecrypt() {
      const data = new Uint8Array(Texcret.ubuf($("#ct").value));
      const res = await Texcret.decrypt(data);
      const pt = Texcret.dec.decode(res.buffer);
      Texcret.log("üîì Decrypted plaintext:", pt);
      $("#pt").value = pt;
    }

    // ---- Fake: generate random secret (not stored anywhere)
    async function doFake() {
      const secret = Texcret.randBytes(32); // store this in largeBlob
      const secretB64 = Texcret.b64(secret); // ArrayBuffer -> b64
      Texcret._secretsB64.push(secretB64);
      $("#authState").textContent = "" + (Texcret._secretsB64.length) + " secret(s): loaded (last fake)";
      $("#authState").className = "ok";
      Texcret.log("‚úÖ Faked secret (" + (secret.byteLength) + " bytes) " + secretB64);
    }

    /* ======= shuffle array https://en.wikipedia.org/wiki/Fisher‚ÄìYates_shuffle ====== */
    function shuffle(array) {

      let currentIndex = array.length;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {

        // Pick a remaining element...
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
    }

    $('#decrypt').onclick = doDecrypt;
    $('#encrypt').onclick = doEncrypt;
    $('#register').onclick = doRegister;
    $('#authenticate').onclick = doAuthenticate;
    $('#fake').onclick = doFake;
    $('#shuffle').onclick = () => {
      x = Texcret._secretsB64;
      shuffle(x);
      Texcret._secretsB64 = x;
      console.log(Texcret._secretsB64);
    };
  }
</script>

<script defer src="texcret.js" onload="init();"></script>

</html>