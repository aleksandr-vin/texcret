<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Tex(t Se)cret demo</title>
<style>
  body {
    align-items: center;
    /* vertical centering */
    justify-content: center;
    /* horizontal centering */

    font: 24px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

    max-width: 95%;
    margin: 3rem auto;
  }

  /* Make all elements inherit font (form elements don‚Äôt by default) */
  *,
  input,
  button,
  textarea,
  select {
    font: inherit;
  }

  .ref-info {
    font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  button {
    padding: .6rem 1rem;
    margin-right: .5rem;
  }

  #log {
    white-space: pre-wrap;
    background: #f6f6f8;
    padding: 1rem;
    border-radius: 8px;
  }

  .pass {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }

  .inputs {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }

  .examples {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }
</style>
<h2>Tex(t Se)cret demo</h2>
<div class="ref-info">
  <p>
    Check on <a href="https://github.com/aleksandr-vin/texcret">github</a>.
  </p>
</div>

<p><button id="register">Register key + store secret</button> Register writes a secret into the key‚Äôs largeBlob</p>
<p><button id="authenticate">Authenticate + read secret</button> Authenticate reads it and decrypts it</p>
<p><button id="fake">Fake secret</button> Generates random secret for the demo</p>
<p><button id="pass-to-secret">Load secret from password</button> Loads secret from the password</p>

<div class="pass">
  <p>
    <label for="password">Password:</label>
    <input name="password" id="password" type="password" value="" />
  </p>
  <p>
    <label for="confirm">Confirm:</label>
    <input name="confirm" id="confirm" type="password" value="" />
  </p>
</div>

<p><span id="authState" class="muted">(secret not loaded)</span></p>

<p><button id="shuffle">Shuffle secrets</button> Shuffles secrets for the demo</p>

<hr />

<p><button id="encrypt">Encrypt sample text</button> (with loaded secrets)</p>
<p><button id="decrypt">Decrypt sample text</button> (trying all loaded secrets until success)</p>

<p>
<div class="inputs">
  <p>
    <label for="pt">Plaintext:</label>
  </p>
  <p>
    <textarea name="pt" id="pt" value="" rows="3" cols="59">hello from the sea üê¨</textarea>
  </p>
  <p>
    <label for="ct">Ciphertext (base64):</label>
  </p>
  <p>
    <textarea name="ct" id="ct" value="" rows="6" cols="59"></textarea>
  </p>
</div>
</p>

<hr />

<p><button id="decretex">Decretex</button> Decrypt all texcrets on the page (you can also try magic!)</p>

<div class="examples">
  <h3>Examples for https://mac.home</h3>
  Look, Ma:
  <p>
    This is encrypted with passkey on
    mac:<i>WUtMQjIAHs04KM7YT67+/V9YAA5zb21lIGZpbGUgbmFtZQABuO3+bQ6pCwvVVa+AbZ0WwfYWYxUMQcwCcdf0rQAwIt/KO+70mUK9xgk6lxeyf+sMn1EvZvMrNV+q1dtaEGYeUiAeJGXTTr9/Dn7DvNGM5jPtKFBND5geEBReHuisP9zF8GXMESnekvoCARLMam1ArTlnH4HMXQ==!!!!!</i>
  </p>
  <p>
    This on
    iPhone:WUtMQjIA9RnI7of/syU1zGfqAA5zb21lIGZpbGUgbmFtZQABg2mLmBBMhebKSN4/mmH/Fg6OtAS1Y8j7EIGI3gAwJohJb991Kc3yPEtIQoOdAXfuOzgeXSEeHbG0UbS3LG1rEsRXVP8iaUd3OuwcCy4bW7ImuyrmcNOOk96jwSgIQNhPVbWWVlwoBmWOhpQ9n+qH2bsy4xl+:))
  </p>
  <p>
    And this with password
    (<code>dark secrets</code>) and passkey on
    mac:<code>WUtMQjIAMK4lyaHMMPDRjo66AA5zb21lIGZpbGUgbmFtZQACxSWv1bbth5mpqlzM7tUT226IQVIawLbOAnu8NAAwe2r+WmS7VNWEdYAlLiFZLFw50LaUHN/NJ4WZkGN2e4tMoufa0ZDqR45BHAgBTVYmOutIDxU1a7rBq99plIzenxEFVMVIh8qSnFRO7QAwvsQmEOHvzfV7K3dywrg9dp6ZD++Y5k+xT3cBj0Q+mDy9lBH2VdM8sCeXNsa5n8jlaeUza5Z9HMH1eyCL3z2m9q0HHPS1VlYi+E+C/kYRmdxuMVc=</code>
  </p>
</div>

<div class="examples">
  <h3>Examples for https://aleksandr.vin/texcret/</h3>
  Look, Ma:
  <p>
    This is encrypted with passkey on
    mac:<i>WUtMQjIA4RIx7tSh9VMwVLyQAA5zb21lIGZpbGUgbmFtZQABEzjo0nt4z25QwngSwZC/y8gvj19hJR0QiY8byAAw6tCWLCughCS6n1M6NE405qL2nXaQnw6YzDxcZHSdPWeK2rOdK4rJPrXEUJNxW7gccQ3EulzTARDcaRFMA/gR8bWB/H6f1mRW3F1ZfgZk7RUco89jVIoGpgRD41vZ37gTnnLjXiS4DjTUw9z+8vzhJw==</i>
  </p>
  <p>
    This on
    iPhone:WUtMQjIAvttQnv9JbxJLXopdAA5zb21lIGZpbGUgbmFtZQABerY5PWO3mwq0gOs9G7anyMI/FZqtAHCDP9OJVgAwlRPoCaQlJ0UY5/bSbb1Y+aRZleWH9dbvZ3wsnTV+Qi1HpTRH8e0hPS6nD/QZxPXJwBRrzhFKV+gEFnht2/m9QG6xx/FXKhbEw1GP6LHeVp1hxiWUfp2N:))
  </p>
  <p>
    And this with password
    (<code>dark secrets</code>) and passkey on
    mac:<code>WUtMQjIA3Z7HvLgDHrSw5RXxAA5zb21lIGZpbGUgbmFtZQACnnN1/iqic5ZrHGCBjbViDr6bjIeaAIbx26S5SgAwnlWKM5pLY3rzk+XO5pMsST0lNJwr6sNadDgESIB/igQx1k+vludisQ+QcRk+ozmsI1H6DGIu5wqZVbMXg17cnFy/Zr9RUesHmSJ9gQAwFQCK6ACKLv8EZo50bwICJgOHSFjxxcjnQD4W27DryGqCZrFFTrSZGEDRpAz1nQC2LsleZpEev/kp9GrjjA3HpkhPATXfrd/YDNZNJoLQf22/+Rjv8cp+BW2yNymGv0L91kxZZW1wNNRetEQ=</code>
  </p>
</div>

<hr />

<p>
<div id="log"></div>
</p>

<script>

  const $ = (sel) => { return document.querySelector(sel); };
  const log = (...a) => { $('#log').textContent += a.join(' ') + "\n"; };

  async function init() {
    Texcret.log = log;

    Texcret.setRPName("Tex(t Se)cret Demo");
    Texcret.setUser("jay@example.com", "Jay");

    let secretsLoaded = 0;

    async function doRegister() {
      await Texcret.registerNewCredentialAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from registration)";
        $("#authState").className = "ok";
      });
    }

    async function doAuthenticate() {
      await Texcret.authenticateAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from authentication)";
        $("#authState").className = "ok";
      });
    }

    async function doLoadPassword() {
      const pass = $("#password").value;
      const confirm = $("#confirm").value;
      if (pass != confirm) {
        log("‚ùå Password does not match confirmation!");
        return;
      }
      await Texcret.loadPassword(pass, onOk = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last is password)";
        $("#authState").className = "ok";
      }, onError = (msg) => {
        log(msg);
      });
    }

    async function doEncrypt() {
      const data = Texcret.enc.encode($("#pt").value);
      const out = await Texcret.encrypt(data, "some file name");
      if (out) {
        $("#ct").value = Texcret.b64(out.buffer);
      }
    }

    async function doDecrypt() {
      const data = new Uint8Array(Texcret.ubuf($("#ct").value));
      const res = await Texcret.decrypt(data);
      if (res) {
        const pt = Texcret.dec.decode(res.buffer);
        log("üîì Decrypted plaintext:", pt);
        $("#pt").value = pt;
      }
    }

    // ---- Fake: generate random secret (not stored anywhere)
    async function doFake() {
      const secret = Texcret.randBytes(32); // store this in largeBlob
      const secretB64 = Texcret.b64(secret); // ArrayBuffer -> b64
      Texcret._secretsB64.push(secretB64);
      secretsLoaded += 1;
      $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last fake)";
      $("#authState").className = "ok";
      log("‚úÖ Faked secret (" + (secret.byteLength) + " bytes) " + secretB64);
    }

    async function doDecretex() {
      const matches = await Texcret.findAllTexcrets();
      const nodes = matches.map((v) => v.node);
      await Texcret.decretex(nodes);
    }

    /* ======= shuffle array https://en.wikipedia.org/wiki/Fisher‚ÄìYates_shuffle ====== */
    function shuffle(array) {

      let currentIndex = array.length;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {

        // Pick a remaining element...
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
    }

    $('#decrypt').onclick = doDecrypt;
    $('#encrypt').onclick = doEncrypt;
    $('#register').onclick = doRegister;
    $('#authenticate').onclick = doAuthenticate;
    $('#pass-to-secret').onclick = doLoadPassword;
    $('#fake').onclick = doFake;
    $('#shuffle').onclick = () => {
      x = Texcret._secretsB64;
      shuffle(x);
      Texcret._secretsB64 = x;
      console.log(Texcret._secretsB64);
    };
    $('#decretex').onclick = doDecretex;

    await Texcret.magic();
  }
</script>

<script defer src="texcret.js" onload="init();"></script>
<!-- <script defer src="texcret.js" onload="Texcret.magic();"></script> -->

</html>