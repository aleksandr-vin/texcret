<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<title>Tex(t Se)cret demo</title>
<style>
  body {
    font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    max-width: 700px;
    margin: 3rem auto;
  }

  button {
    padding: .6rem 1rem;
    margin-right: .5rem;
  }

  #log {
    white-space: pre-wrap;
    background: #f6f6f8;
    padding: 1rem;
    border-radius: 8px;
  }

  .pass {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }

  .inputs {
    background: #dddddd;
    padding: 1rem;
    border-radius: 0px;
  }
</style>
<h2>Tex(t Se)cret demo</h2>

<p><button id="register">Register key + store secret</button> Register writes a secret into the key‚Äôs largeBlob</p>
<p><button id="authenticate">Authenticate + read secret</button> Authenticate reads it and decrypts it</p>
<p><button id="fake">Fake secret</button> Generates random secret for the demo</p>
<p><button id="pass-to-secret">Load secret from password</button> Loads secret from the password</p>

<div class="pass">
  <p>
    <label for="password">Password:</label>
    <input name="password" id="password" type="password" value="" />
  </p>
  <p>
    <label for="confirm">Confirm:</label>
    <input name="confirm" id="confirm" type="password" value="" />
  </p>

</div>

<p><span id="authState" class="muted">(secret not loaded)</span></p>

<p><button id="shuffle">Shuffle secrets</button> Shuffles secrets for the demo</p>

<hr />

<p><button id="encrypt">Encrypt sample text</button> (with loaded secrets)</p>
<p><button id="decrypt">Decrypt sample text</button> (trying all loaded secrets until success)</p>

<p>
<div class="inputs">
  <p>
    <label for="pt">Plaintext:</label>
  </p>
  <p>
    <textarea name="pt" id="pt" value="" rows="3" cols="60">hello from the sea üê¨</textarea>
  </p>
  <p>
    <label for="ct">Ciphertext (base64):</label>
  </p>
  <p>
    <textarea name="ct" id="ct" value="" rows="6" cols="60"></textarea>
  </p>
</div>
</p>

<hr />

<p><button id="decretex">Decretex</button> Decrypt all texcrets on the page (that have <code>.texcreted</code> class)
</p>

<p class="texcreted">
  WUtMQjIAHs04KM7YT67+/V9YAA5zb21lIGZpbGUgbmFtZQABuO3+bQ6pCwvVVa+AbZ0WwfYWYxUMQcwCcdf0rQAwIt/KO+70mUK9xgk6lxeyf+sMn1EvZvMrNV+q1dtaEGYeUiAeJGXTTr9/Dn7DvNGM5jPtKFBND5geEBReHuisP9zF8GXMESnekvoCARLMam1ArTlnH4HMXQ==
</p>

<p class="texcreted">
  WUtMQjIA9RnI7of/syU1zGfqAA5zb21lIGZpbGUgbmFtZQABg2mLmBBMhebKSN4/mmH/Fg6OtAS1Y8j7EIGI3gAwJohJb991Kc3yPEtIQoOdAXfuOzgeXSEeHbG0UbS3LG1rEsRXVP8iaUd3OuwcCy4bW7ImuyrmcNOOk96jwSgIQNhPVbWWVlwoBmWOhpQ9n+qH2bsy4xl+
</p>

<hr />

<p>
<div id="log"></div>
</p>

<script>

  const $ = (sel) => { return document.querySelector(sel); };
  const log = (...a) => { $('#log').textContent += a.join(' ') + "\n"; };

  async function init() {


    Texcret.log = log;

    Texcret.setRPName("Tex(t Se)cret Demo");
    Texcret.setUser("jay@example.com", "Jay");

    let secretsLoaded = 0;

    async function doRegister() {
      await Texcret.registerNewCredentialAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from registration)";
        $("#authState").className = "ok";
      });
    }

    async function doAuthenticate() {
      await Texcret.authenticateAndLoadSecret(onSecretLoaded = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last from authentication)";
        $("#authState").className = "ok";
      });
    }

    async function doLoadPassword() {
      const pass = $("#password").value;
      const confirm = $("#confirm").value;
      if (pass != confirm) {
        log("‚ùå Password does not match confirmation!");
        return;
      }
      await Texcret.loadPassword(pass, onOk = () => {
        secretsLoaded += 1;
        $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last is password)";
        $("#authState").className = "ok";
      }, onError = (msg) => {
        log(msg);
      });
    }

    async function doEncrypt() {
      const data = Texcret.enc.encode($("#pt").value);
      const out = await Texcret.encrypt(data, "some file name");
      if (out) {
        $("#ct").value = Texcret.b64(out.buffer);
      }
    }

    async function doDecrypt() {
      const data = new Uint8Array(Texcret.ubuf($("#ct").value));
      const res = await Texcret.decrypt(data);
      if (res) {
        const pt = Texcret.dec.decode(res.buffer);
        log("üîì Decrypted plaintext:", pt);
        $("#pt").value = pt;
      }
    }

    // ---- Fake: generate random secret (not stored anywhere)
    async function doFake() {
      const secret = Texcret.randBytes(32); // store this in largeBlob
      const secretB64 = Texcret.b64(secret); // ArrayBuffer -> b64
      Texcret._secretsB64.push(secretB64);
      secretsLoaded += 1;
      $("#authState").textContent = "" + (secretsLoaded) + " secret(s): loaded (last fake)";
      $("#authState").className = "ok";
      log("‚úÖ Faked secret (" + (secret.byteLength) + " bytes) " + secretB64);
    }

    async function doDecretex() {
      await Texcret.decretex();
    }

    /* ======= shuffle array https://en.wikipedia.org/wiki/Fisher‚ÄìYates_shuffle ====== */
    function shuffle(array) {

      let currentIndex = array.length;

      // While there remain elements to shuffle...
      while (currentIndex != 0) {

        // Pick a remaining element...
        let randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;

        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
    }

    $('#decrypt').onclick = doDecrypt;
    $('#encrypt').onclick = doEncrypt;
    $('#register').onclick = doRegister;
    $('#authenticate').onclick = doAuthenticate;
    $('#pass-to-secret').onclick = doLoadPassword;
    $('#fake').onclick = doFake;
    $('#shuffle').onclick = () => {
      x = Texcret._secretsB64;
      shuffle(x);
      Texcret._secretsB64 = x;
      console.log(Texcret._secretsB64);
    };
    $('#decretex').onclick = doDecretex;
  }
</script>

<script defer src="texcret.js" onload="init();"></script>

</html>